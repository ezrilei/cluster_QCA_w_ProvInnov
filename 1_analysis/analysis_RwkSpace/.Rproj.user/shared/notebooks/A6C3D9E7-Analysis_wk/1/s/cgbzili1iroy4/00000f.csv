"0",""
"0","cluster_necessity_analysis <- function(data, outcome_vars, conditions, unit_id, cluster_id) {"
"0","  "
"0","  # 初始化汇总表（指定列名，防止 add_row 报错）"
"0","  summary_table <- tibble("
"0","    outcome_var = character(),"
"0","    Result_Type = character(),"
"0","    Pooled_Consistency = numeric(),"
"0","    Between_to_Pooled = numeric(), "
"0","    Within_to_Pooled = numeric(),  "
"0","    Pooled_Coverage = numeric()"
"0","  )"
"0","  "
"0","  "
"0","  # 初始化年度表（基础列名，年份列后续动态添加）"
"0","  yearly_table <- tibble("
"0","    outcome_var = character(),"
"0","    Result_Type = character(),"
"0","    指标 = character(),"
"0","    x = character()"
"0","  )  "
"0","  "
"0","  "
"0","  # 遍历每一个结果变量（例如 Y 和 ~Y）"
"0","  for (outcome_var in outcome_vars) {"
"0","    "
"0","    # 遍历每一个条件变量（例如 X1、X2、X3...）"
"0","    for (condition in conditions) {"
"0","      "
"0","      # 条件变量的正反两种形式"
"0","      for (inclusion_type in c("""", ""~"")) {"
"0","        "
"0","        result_label <- paste(inclusion_type, condition, sep = """")"
"0","        "
"0","        # 运行 cluster 分析"
"0","        output <- SetMethods::cluster("
"0","          data = data,"
"0","          results = result_label,"
"0","          outcome = outcome_var,"
"0","          unit_id = unit_id,"
"0","          cluster_id = cluster_id,"
"0","          necessity = TRUE"
"0","        )"
"0","        "
"0","        # 提取主指标"
"0","        pooled_consistency <- output$POCOS"
"0","        between_to_pooled <- output$dBP"
"0","        within_to_pooled <- output$dWP"
"0","        pooled_coverage <- output$Coverages$pooled"
"0","        "
"0","        # 添加到汇总表"
"0","        summary_table <- summary_table %>%"
"0","          tibble::add_row("
"0","            outcome_var = outcome_var,"
"0","            Result_Type = result_label,"
"0","            Pooled_Consistency = pooled_consistency,"
"0","            Between_to_Pooled = between_to_pooled,"
"0","            Within_to_Pooled = within_to_pooled,"
"0","            Pooled_Coverage = pooled_coverage"
"0","          )"
"0","        "
"0","        # 年度数据处理"
"0","        years <- output$cluster_ids %>% "
"0","          gsub(pattern = ""\\(.*\\)"", replacement = """") %>%"
"0","          gsub(pattern = ""\\s+"", replacement = """")"
"0","        BECON <- output$BECOS"
"0","        BECOV <- output$Coverages$between"
"0","        "
"0","        # 构建年度表（两行）"
"0","        df_yearly <- data.frame("
"0","          outcome_var = rep(outcome_var, 2),"
"0","          Result_Type = rep(result_label, 2),"
"0","          指标 = c(""组间一致性"", ""组间覆盖度""),"
"0","          x = c(""Consistencies"", ""Coverages""),"
"0","          stringsAsFactors = FALSE"
"0","        )"
"0","        "
"0","        for (i in seq_along(years)) {"
"0","          df_yearly[[years[i]]] <- c("
"0","            round(BECON[i], 3),"
"0","            round(BECOV[i], 3)"
"0","          )"
"0","        }"
"0","        "
"0","        # 合并到年度总表"
"0","        yearly_table <- bind_rows(yearly_table, df_yearly)"
"0","      }"
"0","    }"
"0","  }"
"0","  "
"0","  # summary_table保留3位小数"
"0","  summary_table <- summary_table %>%"
"0","    mutate(across(where(is.numeric), ~round(., 3)))"
"0","  "
"0","  # 返回最终结果"
"0","  return(list("
"0","    summary_table = summary_table,"
"0","    yearly_table = yearly_table"
"0","  ))"
"0","}"
